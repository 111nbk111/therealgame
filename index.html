<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Cristal Instable ‚Äì Surcharge Fragment√©e</title>
  <style>
    body {
      margin: 0; padding: 0;
      font-family: monospace, sans-serif;
      background: linear-gradient(to bottom, #3f1d63, #000);
      color: #fff; min-height: 100vh;
    }
    .centered {
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      text-align: center; min-height: 100vh; padding: 20px;
    }
    .container {
      max-width: 650px; margin: 30px auto;
      background: #333; border: 2px solid #4b2e7a;
      border-radius: 8px; padding: 20px;
    }
    h1 { font-size: 1.8rem; margin-bottom: 15px; color: #b8b2ff; }
    .button {
      display: inline-block; background: #5f4bb6;
      padding: 10px 14px; border-radius: 6px;
      text-decoration: none; color: #fff; margin: 8px;
      cursor: pointer; border: none; font-size: 1rem;
    }
    .button:hover { background: #7a65d4; }
    .choices button {
      width: 100%; margin: 5px 0; background: #4b2e7a; font-size: 1rem;
    }
    .advert {
      background: #222; padding: 6px; margin-top: 10px;
      border-radius: 4px; font-family: monospace; color: #ffeb8a;
    }
  </style>
</head>
<body>
<div id="app"></div>

<script>
function shuffleArray(arr) {
  return [...arr].sort(() => Math.random() - 0.5);
}

const allQuestions = [
  { text: "Le cristal vibre. Quel outil utilisez-vous ?", choices: ["A. Sceptre", "B. Gants isolants", "C. Injecteur"], correct: "B. Gants isolants" },
  { text: "Une fissure s'ouvre ! Que faire ?", choices: ["A. Mana pur", "B. Refroidir", "C. Fuir"], correct: "B. Refroidir" },
  { text: "Le cristal devient rouge. Il pulse !", choices: ["A. Frapper", "B. Canaliser", "C. Absorber"], correct: "B. Canaliser" },
  { text: "Une onde r√©sonne. R√©action ?", choices: ["A. Se recroqueviller", "B. Analyser freq", "C. Poser cristal miroir"], correct: "C. Poser cristal miroir" },
  { text: "Le sol tremble. Que faire ?", choices: ["A. Stabiliser rune", "B. Sauter dessus", "C. Ignorer"], correct: "A. Stabiliser rune" }
];

let questions = [];
let questionIndex = 0;
let timer = 20;
let intervalID = null;
let started = false;
let accepted = null;
let score = 0;
let logData = [];
let gameOver = false;

/* ================== FONCTIONS DU JEU ================== */
function initGame() {
  const selected = shuffleArray(allQuestions).slice(0, 5).map(q => ({
    ...q,
    choices: shuffleArray(q.choices)
  }));
  questions = selected;
  questionIndex = 0;
  timer = 20;
  score = 0;
  logData = [];
  gameOver = false;
  started = true;
  startTimer();
  render();
}

function startTimer() {
  clearInterval(intervalID);
  intervalID = setInterval(() => {
    timer--;
    if (timer <= 0) penalize();
    render();
  }, 1000);
}

function penalize() {
  logData.push("‚ùå Mauvaise r√©ponse (Temps √©coul√©)");
  nextQuestion();
}

function nextQuestion() {
  if (questionIndex < questions.length - 1) {
    questionIndex++;
    timer = 20;
  } else {
    endGame();
  }
  render();
}

function handleChoice(choice) {
  const currentQ = questions[questionIndex];
  if (choice === currentQ.correct) {
    score++;
    logData.push("‚úÖ Bonne r√©ponse");
  } else {
    logData.push("‚ùå Mauvaise r√©ponse");
  }
  nextQuestion();
}

function endGame() {
  clearInterval(intervalID);
  gameOver = true;
  started = false;
  render();
}

/* ================== CONS√âQUENCES ================== */

function getFinalMessage() {
  if (score === 0) return "üëé R√©sultat : 0 => Perte d'un doigt (l√©ger) !";
  if (score === 1) return "üôÅ Seulement 1 => entorse du poignet.";
  if (score === 2) return "üòê 2 => petite fracture du bras.";
  if (score === 3) return "üôÇ 3 => contusion mod√©r√©e.";
  if (score === 4) return "üëå 4 => √âraflures l√©g√®res.";
  return "üéâ 5 => Indemne ! Cristal stabilis√©.";
}

function getAdvertMessage() {
  if (score === 0) return "/advert *NA* J'ai √©chou√© ! Perte d'un doigt. üò≠";
  if (score === 1) return "/advert *NA* Blessure : entorse du poignet. üôÅ";
  if (score === 2) return "/advert *NA* Fracture du bras. üòê";
  if (score === 3) return "/advert *NA* Contusion mod√©r√©e. üôÇ";
  if (score === 4) return "/advert *NA* √âraflures l√©g√®res. üëå";
  return "/advert *NA* Cristal ma√Ætris√©, indemne ! üéâ";
}

/* ================== GESTION DU ‚ÄúNON‚Äù ================== */
function handleRefusal() {
  score = 0;
  gameOver = true;
  started = false;
  logData.push("üôÖ Refus de combattre => Score=0");
  render();
}

function restartGame() {
  accepted = null;
  started = false;
  render();
}

/* ================== RENDER ================== */
function render() {
  const app = document.getElementById("app");

  // √âcran d‚Äôaccueil
  if (accepted === null) {
    app.innerHTML = `
      <div class="centered">
        <h1>üß™ Vous voulez lutter pour votre vie ?</h1>
        <div>
          <button class="button" style="background:#3cb46e;" onclick="accepted=true;initGame()">Oui</button>
          <button class="button" style="background:#e54848;" onclick="accepted=false;handleRefusal()">Non</button>
        </div>
      </div>
    `;
    return;
  }

  // √âcran de jeu ?
  if (started && !gameOver) {
    if (!questions.length) {
      app.innerHTML = `<div class="centered"><p>Chargement des questions...</p></div>`;
      return;
    }
    const currentQ = questions[questionIndex];
    const logList = logData.map(item => `<li>${item}</li>`).join("");

    app.innerHTML = `
      <div class="container">
        <h1>üí† Cristal Instable ‚Äì Surcharge Fragment√©e</h1>
        <p>‚è≥ Temps restant : <span style="color:#ffeb8a;font-weight:bold;">${timer}</span>s</p>
        <p style="margin:10px 0;">${currentQ.text}</p>
        <div class="choices">
          ${currentQ.choices.map(c => `
            <button class="button" onclick="handleChoice('${c}')">${c}</button>
          `).join("")}
        </div>
        ${
          logList
            ? `<div style="margin-top:20px;">
                <h2 style="color:#b8b2ff;">üßæ Journal :</h2>
                <ul style="font-size:0.9rem;color:#ccc;list-style:disc;margin-left:20px;">
                  ${logList}
                </ul>
              </div>`
            : ""
        }
      </div>
    `;
    return;
  }

  // √âcran de fin
  if (gameOver && !started) {
    const logList = logData.map(item => `<li>${item}</li>`).join("");
    app.innerHTML = `
      <div class="centered">
        <div class="container">
          <h1>üí† Cristal Instable ‚Äì Surcharge Fragment√©e</h1>
          <p style="font-weight:bold;">Score : ${score} / 5</p>
          <p>${getFinalMessage()}</p>
          <p style="margin-top:10px;">üìã Copie et colle ce message dans le chat :</p>
          <div class="advert">${getAdvertMessage()}</div>
          <button class="button" style="margin-top:10px;" onclick="restartGame()">Recommencer</button>
          ${
            logList
            ? `<div style="margin-top:20px;">
                <h2 style="margin-bottom:8px;color:#b8b2ff;">üßæ Journal :</h2>
                <ul style="color:#ccc;font-size:0.9rem;list-style:disc;padding-left:20px;">
                  ${logList}
                </ul>
              </div>`
            : ""
          }
          <p style="margin-top:20px;font-size:0.8rem;font-style:italic;color:#999;">
            R√©alis√© par Kito Ate ‚Äì Scientifique de la guilde Kenky√ª üß¨
          </p>
        </div>
      </div>
    `;
  }
}

// Au chargement
render();
</script>
</body>
</html>
