<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Cristal Instable â€“ Surcharge FragmentÃ©e</title>
  <style>
    /* ====== STYLES GLOBAUX ====== */
    html, body {
      margin: 0; padding: 0;
      height: 100%; width: 100%;
      font-family: monospace, sans-serif;
      background: linear-gradient(to bottom, #3f1d63 0%, #1e0030 100%);
      color: #fff;
    }
    #app {
      display: flex; 
      flex-direction: column;
      justify-content: center; 
      align-items: center;
      text-align: center;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 700px; 
      margin: 20px auto;
      background: #333; 
      border: 2px solid #4b2e7a;
      border-radius: 8px; 
      padding: 20px;
    }
    h1 {
      font-size: 1.8rem; 
      margin-bottom: 15px; 
      color: #b8b2ff;
    }
    .button {
      display: inline-block; 
      background: #5f4bb6;
      padding: 10px 14px; 
      border-radius: 6px;
      text-decoration: none; 
      color: #fff; 
      margin: 6px 8px;
      cursor: pointer; 
      border: none;
      font-size: 1rem;
    }
    .button:hover {
      background: #7a65d4;
    }
    .choices button {
      width: 100%; 
      margin: 5px 0; 
      background: #4b2e7a; 
      font-size: 1rem;
    }
    .bounce {
      animation: bounce 1s infinite alternate;
    }
    @keyframes bounce {
      0% { transform: translateY(0px); }
      100% { transform: translateY(-10px); }
    }
    .advert {
      font-family: monospace;
      color: #ffeb8a;
      margin-top: 8px;
      background: #222;
      padding: 5px;
      border-radius: 4px;
    }
  </style>
</head>
<body>

<div id="app"></div>

<script>
/* ================== FONCTIONS UTILES ================== */
function shuffleArray(arr) {
  return [...arr].sort(() => Math.random() - 0.5);
}

/* ================== LISTE DE QUESTIONS ================== */
const allQuestions = [
  { text: "Le cristal vibre intensÃ©ment. Quel outil utilisez-vous ?", choices: ["A. Sceptre conducteur", "B. Gants isolants", "C. Injecteur Ã  mana"], correct: "B. Gants isolants" },
  { text: "Une fissure s'ouvre ! Que faites-vous ?", choices: ["A. Injecter du mana pur", "B. Le refroidir", "C. Fuir"], correct: "B. Le refroidir" },
  { text: "Le cristal devient rouge. Il pulse !", choices: ["A. Le frapper", "B. Canaliser le flux", "C. Lâ€™absorber"], correct: "B. Canaliser le flux" },
  { text: "Une onde rÃ©sonne dans la piÃ¨ce. RÃ©action ?", choices: ["A. Se recroqueviller", "B. Analyser la frÃ©quence", "C. Poser un cristal miroir"], correct: "C. Poser un cristal miroir" },
  { text: "Le sol tremble lÃ©gÃ¨rement.", choices: ["A. Stabiliser avec une rune", "B. Sauter dessus", "C. Ignorer le phÃ©nomÃ¨ne"], correct: "A. Stabiliser avec une rune" },
  { text: "Des Ã©clats flottent autour du cristal.", choices: ["A. Utiliser une cage de stabilisation", "B. Toucher les Ã©clats", "C. Attendre sans rien faire"], correct: "A. Utiliser une cage de stabilisation" },
  { text: "Un sifflement aigu se fait entendre.", choices: ["A. Couvrir ses oreilles", "B. RÃ©sonner avec un champ de mana", "C. Parler au cristal"], correct: "B. RÃ©sonner avec un champ de mana" },
  { text: "Le cristal devient noir quelques secondes.", choices: ["A. Souffler dessus", "B. Lâ€™Ã©loigner", "C. Injecter un peu de lumiÃ¨re"], correct: "C. Injecter un peu de lumiÃ¨re" },
  { text: "Une aura froide envahit la piÃ¨ce.", choices: ["A. Canaliser de la chaleur interne", "B. Sortir immÃ©diatement", "C. Taper le mur"], correct: "A. Canaliser la chaleur interne" }, // Correction: canaliser la chaleur
  { text: "Le cristal projette une image inconnue.", choices: ["A. Tenter une communication mentale", "B. La briser", "C. Toucher lâ€™image"], correct: "A. Tenter une communication mentale" }
];

// Variables globales
let questions = [];
let questionIndex = 0;
let timer = 20;
let showExplosion = false;
let gameOver = false;
let score = 0;
let logData = [];
let accepted = null;  // oui / non
let started = false;
let intervalID = null;

/* ========== INIT ========== */
function initGame() {
  // SÃ©lection 10 questions alÃ©atoires
  const selected = shuffleArray(allQuestions).slice(0, 10).map(q => ({
    ...q,
    choices: shuffleArray(q.choices)
  }));
  questions = selected;
  questionIndex = 0;
  timer = 20;
  score = 0;
  showExplosion = false;
  gameOver = false;
  logData = [];
  started = true;

  startTimer();
  render();
}

function startTimer() {
  clearInterval(intervalID);
  intervalID = setInterval(() => {
    timer--;
    if (timer <= 0) {
      penalize();
    }
    render();
  }, 1000);
}

function penalize() {
  logData.push("âŒ Mauvaise rÃ©ponse (Temps Ã©coulÃ©)");
  nextQuestion();
}

function nextQuestion() {
  if (questionIndex < questions.length - 1) {
    questionIndex++;
    timer = 20;
  } else {
    endGame();
  }
  render();
}

function handleChoice(choice) {
  const currentQ = questions[questionIndex];
  if (choice === currentQ.correct) {
    score++;
    logData.push("âœ… Bonne rÃ©ponse");
  } else {
    logData.push("âŒ Mauvaise rÃ©ponse");
  }
  nextQuestion();
}

function endGame() {
  gameOver = true;
  started = false;
  clearInterval(intervalID);
  if (score < 5) showExplosion = true;
  render();
}

/* ========== MESSAGES FINAUX ========== */
function getAdvertMessage() {
  if (score === 0) return "/advert *NA* L'utilisateur a Ã©chouÃ©. Le cristal l'a consumÃ©. Ã‰tat : CK â˜ ï¸";
  if (score < 2) return "/advert *NA* Blessures critiques : perte d'un Å“il et d'une main. Gravement touchÃ© ğŸ©¸";
  if (score < 5) return "/advert *NA* Perte d'une main ğŸ–ï¸ Ã  la suite d'une mauvaise manipulation.";
  return "/advert *NA* Le cristal a Ã©tÃ© stabilisÃ© avec succÃ¨s. Aucun membre perdu. ğŸ‰";
}

function getFinalMessage() {
  if (score === 0) return "â˜ ï¸ Ã‰chec total. Le cristal vous consume. Vous Ãªtes dÃ©clarÃ© CK.";
  if (score < 2) return "ğŸ©¸ RÃ©sultat critique : Perte d'un Å“il et d'une main. Ã‰tat : gravement blessÃ©.";
  if (score < 5) return "ğŸ–ï¸ RÃ©sultat faible : Perte d'une main.";
  return "ğŸ‰ Cristal stabilisÃ©. Aucun membre perdu de faÃ§on dÃ©finitive.";
}

function getWhatIfMessage() {
  return `
    <h3 style="color:#7cafff;margin-top:10px;">ğŸ§  Et si tu avais Ã©chouÃ© ?</h3>
    <ul style="margin-left:20px;color:#ccc;font-size:0.9rem;">
      <li>0 bonnes rÃ©ponses : CK instantanÃ© â˜ ï¸</li>
      <li>1 Ã  2 bonnes rÃ©ponses : Perte d'un Å“il + d'une main ğŸ©¸</li>
      <li>3 Ã  4 bonnes rÃ©ponses : Perte d'une main ğŸ–ï¸</li>
      <li>5 ou plus : survivant ğŸ§â€â™‚ï¸</li>
    </ul>
  `;
}

/* ========== REFUS ========== */
function handleRefusal() {
  accepted = false;
  score = 0;
  gameOver = true;
  showExplosion = true;
  started = false;
  questions = [];
  logData = ["Le joueur a refusÃ© le test."];
  render();
}

function restartGame() {
  accepted = null;
  started = false;
  clearInterval(intervalID);
  render();
}

/* ========== RENDER ========== */
function render() {
  const app = document.getElementById("app");

  // Ã‰CRAN 1 : question oui/non
  if (accepted === null) {
    app.innerHTML = `
      <div>
        <h1 style="font-size:2rem;">ğŸ§ª Vous voulez lutter pour votre vie ?</h1>
        <div>
          <button class="button" style="background:#3cb46e;" onclick="accepted=true;initGame();">Oui</button>
          <button class="button" style="background:#e54848;" onclick="accepted=false;handleRefusal();">Non</button>
        </div>
      </div>
    `;
    return;
  }

  // Refus => score=0, ecran fin
  if (!started && !questions.length && accepted === false && gameOver) {
    const logList = logData.map(item => `<li>${item}</li>`).join("");
    app.innerHTML = `
      <div class="container">
        <h1>ğŸ’  Cristal Instable â€“ Surcharge FragmentÃ©e</h1>
        <p style="font-weight:bold;">Score : ${score} / 10</p>
        <p style="margin:10px 0;color:#fbb;">${getFinalMessage()}</p>
        ${
          showExplosion 
          ? `<div style="margin-top:10px;color:#f66;font-weight:bold;" class="bounce">ğŸ’¥ Une explosion cristalline secoue la piÃ¨ce !</div>`
          : ""
        }
        ${getWhatIfMessage()}
        <p style="margin:10px 0;color:#ffb700;font-size:0.9rem;">ğŸ“‹ Copie et colle ce message dans le chat en jeu :</p>
        <div class="advert">${getAdvertMessage()}</div>
        <button class="button" style="margin-top:10px;" onclick="restartGame()">ğŸ”„ Recommencer</button>
        ${
          logList 
          ? `<div style="margin-top:20px;">
              <h2 style="margin-bottom:8px;color:#b8b2ff;">ğŸ§¾ Journal :</h2>
              <ul style="color:#ccc;font-size:0.9rem;list-style:disc;padding-left:20px;">
                ${logList}
              </ul>
            </div>`
          : ""
        }
        <p style="margin-top:20px;font-size:0.8rem;font-style:italic;color:#999;">
          RÃ©alisÃ© par Kito Ate â€“ Scientifique de la guilde KenkyÃ» ğŸ§¬
        </p>
      </div>
    `;
    return;
  }

  // Pas de questions => chargement
  if (!questions.length && started) {
    app.innerHTML = `
      <div>
        <p>Chargement des questions...</p>
      </div>
    `;
    return;
  }

  // Ã‰cran de fin normal
  if (gameOver && !started && questions.length) {
    const explosionMarkup = showExplosion
      ? `<div style="margin-top:10px;color:#f66;font-weight:bold;" class="bounce">ğŸ’¥ Une explosion cristalline secoue la piÃ¨ce !</div>`
      : "";
    const logList = logData.map(item => `<li>${item}</li>`).join("");

    app.innerHTML = `
      <div class="container">
        <h1>ğŸ’  Cristal Instable â€“ Surcharge FragmentÃ©e</h1>
        <p style="font-weight:bold;">ğŸ” RÃ©sultats :</p>
        <p style="color:lightgreen;">Score : ${score} / 10</p>
        <p style="margin:10px 0;color:#fbb;">${getFinalMessage()}</p>
        ${explosionMarkup}
        ${getWhatIfMessage()}
        <p style="margin:10px 0;color:#ffb700;font-size:0.9rem;">ğŸ“‹ Copie et colle ce message dans le chat en jeu :</p>
        <div class="advert">${getAdvertMessage()}</div>
        <button class="button" style="margin-top:10px;" onclick="restartGame()">ğŸ”„ Recommencer</button>
        
        ${
          logList 
          ? `<div style="margin-top:20px;">
              <h2 style="margin-bottom:8px;color:#b8b2ff;">ğŸ§¾ Journal :</h2>
              <ul style="color:#ccc;font-size:0.9rem;list-style:disc;padding-left:20px;">
                ${logList}
              </ul>
            </div>`
          : ""
        }
        <p style="margin-top:20px;font-size:0.8rem;font-style:italic;color:#999;">
          RÃ©alisÃ© par Kito Ate â€“ Scientifique de la guilde KenkyÃ» ğŸ§¬
        </p>
      </div>
    `;
    return;
  }

  // Ã‰cran de jeu en cours
  const currentQ = questions[questionIndex];
  const logList = logData.map(item => `<li>${item}</li>`).join("");
  app.innerHTML = `
    <div class="container">
      <h1>ğŸ’  Cristal Instable â€“ Surcharge FragmentÃ©e</h1>
      <p>â³ Temps restant : <span style="color:#ffeb8a;font-weight:bold;">${timer}s</span></p>
      <p style="margin:10px 0;">${currentQ.text}</p>
      <div class="choices">
        ${currentQ.choices.map((choice) => `
          <button class="button" onclick="handleChoice('${choice}')">${choice}</button>
        `).join("")}
      </div>
      ${
        logList
          ? `<div style="margin-top:20px;">
              <h2 style="color:#b8b2ff;">ğŸ§¾ Journal :</h2>
              <ul style="font-size:0.9rem;color:#ccc;list-style:disc;margin-left:20px;">
                ${logList}
              </ul>
            </div>`
          : ""
      }
    </div>
  `;
}

/* ====== REFUS ====== */
function handleRefusal() {
  accepted = false;
  score = 0;
  gameOver = true;
  showExplosion = true;
  started = false;
  questions = [];
  logData = ["Le joueur a refusÃ© le test."];
  render();
}

/* ====== Lancement initial ====== */
render();
</script>

</body>
</html>
